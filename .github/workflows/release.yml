# SurrealDB Release Workflow
#
# This workflow handles both nightly and versioned releases with full idempotency.
# For comprehensive documentation, see doc/RELEASING.md
#
# Quick reference:
# - Nightly: Automated daily builds from main (scheduled at midnight UTC)
# - Versioned: Pre-releases (alpha/beta/rc), stable releases (X.Y.0), and patches (X.Y.Z)
# - Always dry-run first (publish: false) before publishing
# - Workflow is fully idempotent - safe to retry on failure
#
# Nightly releases are triggered automatically via schedule

name: Release

run-name: "${{ github.event_name == 'schedule' && 'Nightly release' || format('Release {0} (type: {1}, publish: {2}, latest: {3})', inputs.git-ref, inputs.release-type, inputs.publish, inputs.latest) }}"

on:
  workflow_dispatch:
    inputs:
      release-type:
        required: true
        type: choice
        default: nightly
        description: "Type of release"
        options:
          - nightly
          - versioned
      release-version:
        required: false
        type: string
        description: "Semantic version (e.g., 3.0.0-beta.1)"
      git-ref:
        required: true
        type: string
        default: main
        description: "The git ref of this release"
      publish:
        required: false
        type: boolean
        default: false
        description: "Publish the release"
      latest:
        required: false
        type: boolean
        default: false
        description: "Mark as latest release"
      update-main:
        required: false
        type: boolean
        default: false
        description: "Update main branch version"
      main-version:
        required: false
        type: string
        description: "Override auto-calculated main version"
      extra-features:
        required: false
        type: string
        default: storage-tikv,jwks,ml
        description: "Extra features enabled in the binary"
  schedule:
    - cron: "0 0 * * *"

defaults:
  run:
    shell: bash

permissions:
  contents: write
  pull-requests: write

jobs:
  # ----------------------------------------
  # Validate inputs
  # ----------------------------------------

  validate-inputs:
    name: Validate inputs
    runs-on: ubuntu-latest
    steps:
      - name: Validate release inputs
        shell: bash
        env:
          SEMVER_REGEX: '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'
        run: |
          if [[ "${{ inputs.release-type }}" == "versioned" ]]; then
            if [[ -z "${{ inputs.release-version }}" ]]; then
              echo "Error: 'release-version' is required when release-type is 'versioned'"
              echo "Please provide a version number (e.g., 3.0.0-beta.1)"
              exit 1
            fi
            # Validate release-version format
            if [[ ! "${{ inputs.release-version }}" =~ $SEMVER_REGEX ]]; then
              echo "Error: 'release-version' must be a valid semver (e.g., 3.0.0-beta.1, 3.0.0)"
              exit 1
            fi
          fi

          if [[ "${{ inputs.release-type }}" == "nightly" ]]; then
            if [[ -n "${{ inputs.release-version }}" ]]; then
              echo "Warning: 'release-version' is ignored for nightly releases"
            fi
            if [[ "${{ inputs.update-main }}" == "true" ]]; then
              echo "Warning: 'update-main' is ignored for nightly releases"
            fi
            if [[ "${{ inputs.latest }}" == "true" ]]; then
              echo "Warning: 'latest' is ignored for nightly releases"
            fi
            if [[ -n "${{ inputs.main-version }}" ]]; then
              echo "Warning: 'main-version' is ignored for nightly releases"
            fi
          fi

          # Validate main-version if provided
          if [[ -n "${{ inputs.main-version }}" ]]; then
            if [[ "${{ inputs.update-main }}" != "true" ]]; then
              echo "Warning: 'main-version' is specified but 'update-main' is false - it will be ignored"
            fi
            # Basic format validation - should look like a semver
            if [[ ! "${{ inputs.main-version }}" =~ $SEMVER_REGEX ]]; then
              echo "Error: 'main-version' must be a valid semver (e.g., 4.0.0-alpha, 3.1.0-beta)"
              exit 1
            fi
          fi

  # ----------------------------------------
  # Bump version (optional)
  # ----------------------------------------
  # Release branch strategy:
  # - Temporary branch: releases/v{version} (e.g., releases/v3.0.0-beta.1)
  #   * Created during version bump, deleted after successful release
  #   * For patch releases (X.Y.Z), manually create a branch from the previous tag
  # - Main branch version (when update-main is true):
  #   * If main-version specified: uses that exact version
  #   * Pre-releases: auto-strips patch (3.0.0-beta.1 -> 3.0.0-beta)
  #   * Stable x.y.0: auto-bumps to next minor alpha (3.0.0 -> 3.1.0-alpha)
  #   * For major transitions, specify main-version explicitly (e.g., 4.0.0-alpha)

  bump-version:
    needs: [validate-inputs]
    name: Bump version
    runs-on: ubuntu-latest
    outputs:
      release-branch: ${{ steps.bump.outputs.release-branch }}
    steps:
      - name: Checkout sources
        if: ${{ inputs.release-type == 'versioned' }}
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ inputs.git-ref }}
          fetch-depth: 0
          ssh-key: ${{ secrets.RELEASE_DEPLOY_KEY }}

      - name: Setup environment
        if: ${{ inputs.release-type == 'versioned' }}
        uses: ./.github/actions/setup-environment

      - name: Install cargo-edit
        if: ${{ inputs.release-type == 'versioned' }}
        run: cargo install cargo-edit

      - name: Bump version and commit
        if: ${{ inputs.release-type == 'versioned' }}
        id: bump
        run: .github/scripts/bump-version.sh "${{ inputs.release-version }}" "$GITHUB_OUTPUT"

      - name: Create PR to update main
        if: ${{ inputs.update-main == true && inputs.release-type == 'versioned' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/update-main-version.sh "${{ inputs.release-version }}" "${{ inputs.publish }}" "${{ inputs.main-version }}"
